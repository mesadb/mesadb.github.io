# Mesa: Geo-Replicated, Near Real-Time, Scalable Data Warehousing


##  摘要

**Edit by** <theseusyang@gmail.com>


Mesa是一个高度可扩展的分析型数据仓库系统，用于存储Google互联网广告业务相关的关键衡量数据。Mesa的设计目的是满足一系列复杂而有挑战性的用户与系统需求，包括近实时的数据获取和查询、高可用性、可靠性、容错和（大规模数据与查询量的）可扩展性。Mesa可以应对P级数据，每秒处理数百万行更新，每天抓取数万亿行以支持数十亿查询。Mesa是跨多个数据中心异地复制的，即使整个数据中心故障，仍然能够以较低延迟返回一致和可重复的查询结果。

## 1 介绍

Google跨多个渠道运行着一个可扩展的广告平台，每天为全球客户处理数十亿条的广告信息。详细信息与广告信息关联，例如目标标准、点击和流量等，对其进行实时记录和处理。数据用于google的多个应用场景中，包括报表、内部审计、分析、竞价、预测等。广告商获得了更细粒度地对广告营销活动的监测，前台服务提交到后台数据存储的在线和按需查询。Google的内部广告平台使用此数据实时决策预算和以前服务广告的绩效以增强现在和未来广告的关联。当Google广告平台继续扩展，同时内外部用户请求对于它们的广告活动可视度更高，对更详细的、更细粒度信息的需求导致了数据量的急速增长。规模和业务的关键特性导致了在处理、存储和查询方面给技术和运营带来了巨大挑战。

数据存储的需求如下；

•	**原子更新**。在关系型数据水平上，一个用户活动可能导致多个更新，影响着数千个一致性视图，同时跨多个维度集合定义了多指标集合(点击和成本)。此系统在进行多个更新操作时，保证每个更新是原子性的。•	**一致性和正确性**。由于业务特性原因，Mesa系统必须返回一致性和正确性的数据。我们需要强一致性和可重复的查询结果，即使此查询涉及到多个数据中心。•	**近实时更新吞吐**。在新生成行数据和现有行数据的增量更新方面，Mesa系统支持持续更新，更新吞吐量满足每秒数百万行数据。 这些更新对于跨不同视图和数据中心的查询是高可用的。•	**查询性能**。此系统支持需要低延时查询用户的需求和需要高吞吐量批量处理的用户需求。总体来说，此系统支持毫秒级延时的查询操作和每天万亿行数据的访问量。•	**高可扩展性**。此系统能够随着数据大小和查询量增长而扩展。此系统支持万亿行数据访问和 PB 级数据存储。•	**在线数据和元数据转换**。为了支持新特性的启动或更改现有数据的颗粒度，客户经常需要转换数据的 Schema 或者修改现有数据值。这些变更在线执行，并不影响正常的查询和更新操作。
Mesa 是上述技术和运营挑战的解决方案. 虽然每个部分问题通过现有数据仓库系统能够解决，但是Mesa 唯一能够同时解决上述问题的解决方案. Mesa 是一个存储结构化数据的分布式、同步、高可用的数据处理、存储和查询系统. Mesa 抓取上游应用服务所生成的数据,聚合和持久化数据,同时为用户提供数据查询服务.即使此论文主要围绕广告服务场景来讨论 Mesa,但是 Mesa 是一个能够解决上述所有需求的,通用的数据仓库解决方案.Mesa 利用通用的Google基础设施和服务,例如Colossus(Google 下一代分布式文件系统)[22, 23], BigTable [12], 和MapReduce [19]. 为了在存储上达到高可扩展性、高可用性,数据进行水平分区和同步.更新可能被应用在单个表或跨多个表的颗粒度上.为了在更新期间, 达到一致性和可重复的查询,如下的数据必须是多版本的.为了使更新是高扩展的,数据更新是批处理的,指定了一个新的版本号,同时周期性地进行更新.为了跨多个数据中心达到更新一致性,Mesa 使用了基于Paxos [35]的分布式同步协议.
大多数商业的数据仓库产品都是基于关系型技术, 同时数据Cube [25]不支持分钟级的短时间持续整合和聚合,不能提供近实时的查询响应.通常情况下,这些解决方案对于传统的企业级应用是适合的,当数据聚合汇总不是很频繁,例如,每日或每周处理.与之类似地,Google的其他解决方案, BigTable [12], Megastore [11], Spanner [18], 和 F1 [41]也不能做到近实时地对数据进行处理.BigTable并不提供Mesa 所能提供的原子性.而Megastore, Spanner, and F1不能够提供跨数据中心的强一致性,它们也不支持由 Mesa 客户端更新数据的超高吞吐量.但, Mesa 的确使用BigTable和Spanner的Paxos技术进行元数据存储和维护.
最近的研究也逐步定位到数据分析引擎和数据仓库的水平扩展.Wong et al. [49]已经为云环境开发出了一个提供并行处理的分析引擎.然而,此系统被设置成了多租户环境. Xin et al. [51]开发出了Shark, 利用分布式共享内存来支持可扩展的数据分析.然而,shark 只集中在内存的分析查询处理. Athanassoulis et al. [10]已经提交了一个MaSM (materialized sort-merge)算法,能够与flash存储结合来支持数据仓库中的在线更新.

本篇突出贡献是:

• 我们展示了怎样创建一个能够处理PB级,带有交易处理系统的ACID语意,同时能够扩展到处理Google广告的高吞吐率的数据仓库.
• 我们描述了一个优雅的的版本管理系统,能够提供可接受的延时和高吞吐量的更新操作,和低延时和高吞吐量的查询性能.• 我们描述了高科扩展的分布式架构,在一个数据中心内部面对服务器和网络故障可以做到弹性伸缩.我们也展示了多地域同步的架构,能够处理数据中心级别的瘫痪.这两个方面的区别在与应用数据能够异步复制到其他数据中心,并且可以在多个数据中心冗余处理.而关键的元数据通过拷贝状态同步复制到所有的节点上.此技术将跨多个数据中心的同步开销降低到最小,同时提供了非常高的更新吞吐量.• 我们展示了怎样改变多个表的Schema,这些变更能够动态执行,同时不影响现有应用的使用.• 我们描述了用于解决由于软件错误和硬件故障而导致的数据故障问题.
• 我们描述了在保证强一致性、正确性和性能的水平上维护一个大型分布式系统的运维挑战,同时推荐了一些新的研究成果来提升现有的技术水平.本论文剩余部分如下.第2章描述 Mesa 的存储子系统。第3章展示 Mesa 的系统架构和描述其多数据中心部署情况.第4章展示 Mesa 的一些高级功能和特性。第5章汇报 Mesa的一些开发经验, 第6章汇报 Mesa生成环境部署情况. 第7章回顾了相关工作，而第8章对本篇论文进行总结.